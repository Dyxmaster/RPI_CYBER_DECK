<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ‘è“æ´¾ä¸­æ¢ç³»ç»Ÿ // V5.1 Wifi Edition</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/nav.css') }}">
    <style>
        /* ... (ä¿ç•™åŸæœ‰æ ·å¼) ... */
        .power-btn {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 4px 12px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 10px;
            transition: 0.3s;
            text-transform: uppercase;
        }
        .power-btn:hover {
            background: var(--danger);
            color: #fff;
            box-shadow: 0 0 10px var(--danger);
        }
        .power-btn.reboot {
            border-color: var(--yellow);
            color: var(--yellow);
        }
        .power-btn.reboot:hover {
            background: var(--yellow);
            color: #000;
            box-shadow: 0 0 10px var(--yellow);
        }
        /* WiFi æŒ‰é’®æ ·å¼ */
        .power-btn.wifi {
            border-color: var(--primary);
            color: var(--primary);
        }
        .power-btn.wifi:hover {
            background: var(--primary);
            color: #000;
            box-shadow: 0 0 10px var(--primary);
        }

        .header-actions {
            display: flex;
            align-items: center;
        }
        
        /* --- 4 + 2 å¸ƒå±€ä¼˜åŒ– CSS --- */
        @media (min-width: 1400px) {
            .cards-grid {
                grid-template-columns: repeat(4, 1fr); 
            }
        }
        @media (min-width: 1400px) {
            .card.span-2-columns {
                grid-column: span 2;
            }
        }

        /* --- é€šç”¨æ¨¡æ€æ¡†åŸºç¡€æ ·å¼ --- */
        .custom-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center; align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .custom-modal.visible {
            display: flex; opacity: 1;
        }
        .modal-content {
            background-color: var(--background-darker); /* ç¡®ä¿ä½ æœ‰è¿™ä¸ªå˜é‡ï¼Œæˆ–è€…ç”¨ #111 */
            border: 1px solid var(--primary);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
            padding: 25px;
            width: 90%;
            max-width: 400px;
            border-radius: 5px;
            color: #fff;
            text-align: center;
            animation: fadeIn 0.3s;
            position: relative;
        }
        @keyframes fadeIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .modal-title {
            font-size: 1.5em; color: var(--yellow); margin-bottom: 10px;
        }
        .modal-message {
            font-size: 1em; color: var(--text-light); margin-bottom: 25px; line-height: 1.5;
        }
        .modal-actions button {
            padding: 8px 20px; margin: 0 10px; cursor: pointer;
            font-weight: bold; border: none; border-radius: 3px; transition: 0.2s;
        }
        .modal-btn-confirm { background-color: var(--danger); color: #fff; }
        .modal-btn-confirm:hover { background-color: #ff4d4f; }
        .modal-btn-cancel { background-color: #555; color: #eee; }
        .modal-btn-cancel:hover { background-color: #666; }

        /* --- WiFi ä¸“å±æ¨¡æ€æ¡†æ ·å¼ --- */
        #wifiModal .modal-content {
            max-width: 500px;
            text-align: left;
        }
        .wifi-list-container {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid #333;
            background: #000;
        }
        .wifi-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #222;
            cursor: pointer;
            transition: background 0.2s;
        }
        .wifi-item:hover {
            background: rgba(0, 255, 255, 0.1);
        }
        .wifi-item.active {
            border-left: 3px solid var(--green);
            background: rgba(0, 255, 0, 0.1);
        }
        .wifi-ssid {
            font-weight: bold;
            color: var(--primary);
        }
        .wifi-info {
            font-size: 0.8em;
            color: #888;
        }
        .wifi-input-group {
            display: none; /* é»˜è®¤éšè—ï¼Œç‚¹å‡»åˆ—è¡¨é¡¹åæ˜¾ç¤º */
            margin-top: 15px;
            border-top: 1px solid #333;
            padding-top: 15px;
        }
        .wifi-input-group input {
            width: 100%;
            padding: 10px;
            background: #111;
            border: 1px solid var(--primary);
            color: #fff;
            margin-bottom: 10px;
        }
        .loader {
            display: inline-block;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            width: 16px; height: 16px;
            animation: spin 1s linear infinite;
            margin-right: 5px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>
    <div class="overlay"></div>
    <div class="scanline"></div>

    <div class="container">
        
        {% include 'nav.html' %}

        <main class="main-content">
            
            <div id="dashboard" class="page active">
                <header>
                    <h2>å®æ—¶ç¡¬ä»¶ç›‘æ§</h2>
                    <div class="header-actions">
                        <button class="power-btn wifi" onclick="openWifiModal()">ğŸ“¶ WiFi è®¾ç½®</button>
                        <button class="power-btn reboot" onclick="showSysConfirm('reboot')">âš¡ é‡å¯ç³»ç»Ÿ</button>
                        <button class="power-btn" onclick="showSysConfirm('shutdown')">ğŸ›‘ ç«‹å³å…³æœº</button>
                        <div class="live-tag" style="margin-left: 15px;">LIVE DATA</div>
                    </div>
                </header>

                <div class="cards-grid">
                    <div class="card danger-border">
                        <div class="card-title">æ ¸å¿ƒæ¸©åº¦</div>
                        <div class="big-value text-red">
                            <span id="temp-val">--</span><small>Â°C</small>
                        </div>
                        <div class="chart-box">
                            <div class="bar-bg">
                                <div class="bar-fill red" id="temp-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="card primary-border">
                        <div class="card-title">CPU è´Ÿè½½</div>
                        <div class="big-value text-green">
                            <span id="cpu-val">--</span><small>%</small>
                        </div>
                        <div class="sub-info">
                            é¢‘ç‡: <span id="cpu-freq">--</span> MHz
                        </div>
                        <div class="bar-bg">
                            <div class="bar-fill green" id="cpu-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="card cyan-border">
                        <div class="card-title">å†…å­˜ä½¿ç”¨ (RAM)</div>
                        <div class="big-value text-cyan">
                            <span id="mem-val">--</span><small>%</small>
                        </div>
                        <div class="sub-info">
                            å·²ç”¨: <span id="mem-used">--</span> GB / æ€»è®¡: <span id="mem-total">--</span> GB
                        </div>
                        <div class="bar-bg">
                            <div class="bar-fill cyan" id="mem-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="card yellow-border">
                        <div class="card-title">å­˜å‚¨ç©ºé—´ (Root)</div>
                        <div class="donut-chart">
                            <svg viewBox="0 0 36 36">
                                <path class="circle-bg"
                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                <path class="circle" id="disk-circle" stroke-dasharray="0, 100"
                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            </svg>
                            <div class="donut-text" id="disk-val">--%</div>
                        </div>
                        <div class="sub-info center">å‰©ä½™ç©ºé—´: <span id="disk-free">--</span> GB</div>
                    </div>
                
                    <div class="card span-2-columns" style="border-top: 3px solid var(--purple);">
                        <div class="card-title">ç³»ç»Ÿè¯¦ç»†æ¦‚è§ˆ</div>
                        <div class="kv-row">
                            <span class="kv-label">ä¸»æœºå</span>
                            <span class="kv-value" id="sys-hostname">--</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">æ“ä½œç³»ç»Ÿ</span>
                            <span class="kv-value" id="sys-os">--</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">IP åœ°å€</span>
                            <span class="kv-value" id="sys-ip">--</span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">CPU æ ¸å¿ƒæ•°</span>
                            <span class="kv-value" id="cpu-cores">--</span>
                        </div>
                    </div>
                
                    <div class="card span-2-columns cyan-border">
                        <div class="card-title">ç³»ç»Ÿè¿è¡Œæ—¶é—´</div>
                        <div class="big-value text-cyan" style="font-size: 48px;">
                            <span id="sys-uptime">--</span>
                        </div>
                        <div class="sub-info">è‡ªä¸Šæ¬¡å¯åŠ¨ä»¥æ¥</div>

                        <div class="kv-row" style="margin-top: 15px;">
                            <span class="kv-label">å†…å­˜ä½¿ç”¨ç‡</span>
                            <span class="kv-value">
                                <span id="mem-percent-small">--</span>%
                            </span>
                        </div>
                        <div class="kv-row">
                            <span class="kv-label">ç£ç›˜ç©ºé—²ç©ºé—´</span>
                            <span class="kv-value">
                                å‰©ä½™ <span id="disk-free-small">--</span> GB
                            </span>
                        </div>
                    </div>

                </div>

                <div class="log-panel">
                    <div class="card-title">ç³»ç»Ÿäº‹ä»¶æ—¥å¿— (SYSTEM LOGS)</div>
                    <div class="log-content" id="log-box">
                        <div class="log-line">System initialized... waiting for data stream.</div>
                    </div>
                </div>
            </div>

            <div id="network" class="page">
                 <header><h2>ç½‘ç»œæµé‡åˆ†æ</h2></header>
                 <div class="card wide">
                     <div class="card-title">å½“å‰ IP åœ°å€</div>
                     <h1 class="text-cyan" id="ip-addr">Loading...</h1>
                 </div>
            </div>

            <div id="terminal" class="page">
                <header><h2>Web SSH (æ¨¡æ‹Ÿ)</h2></header>
                <div class="terminal-window">
                    <div class="term-output">ç”±äºå®‰å…¨é™åˆ¶ï¼Œå½“å‰ä»…æ”¯æŒæŸ¥çœ‹çŠ¶æ€ã€‚</div>
                    <div class="term-input"><span>root@rpi:~#</span> <span class="cursor">_</span></div>
                </div>
            </div>

        </main>
    </div>

    <div id="customModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle"></div>
            <div class="modal-message" id="modalMessage"></div>
            <div class="modal-actions" id="modalActions">
            </div>
        </div>
    </div>

    <div id="wifiModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-title">æ— çº¿ç½‘ç»œæ‰«æ</div>
            <div class="modal-message" style="margin-bottom: 10px;">é€‰æ‹©ä¸€ä¸ªç½‘ç»œè¿›è¡Œè¿æ¥</div>
            
            <div id="wifiList" class="wifi-list-container">
                <div style="padding: 20px;">æ­£åœ¨æ‰«æé™„è¿‘ä¿¡å·... <div class="loader"></div></div>
            </div>
            
            <div id="wifiInputGroup" class="wifi-input-group">
                <div style="text-align: left; color: var(--primary); margin-bottom: 5px;">
                    æ­£åœ¨è¿æ¥: <span id="selectedSsid" style="color: #fff; font-weight: bold;"></span>
                </div>
                <input type="password" id="wifiPassword" placeholder="è¾“å…¥ WiFi å¯†ç " />
                <button class="power-btn wifi" onclick="connectWifi()" style="width: 100%; margin: 0;">ğŸ”— è¿æ¥ç½‘ç»œ</button>
            </div>

            <div class="modal-actions" style="margin-top: 20px; border-top: 1px solid #333; padding-top: 15px;">
                <button class="modal-btn-cancel" onclick="closeWifiModal()">å…³é—­</button>
                <button class="modal-btn-confirm" onclick="refreshWifiList()">ğŸ”„ é‡æ–°æ‰«æ</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // é¡µé¢åŠ è½½æ—¶ï¼Œæ ¹æ®åç«¯ä¼ æ¥çš„ initial_tab è‡ªåŠ¨åˆ‡æ¢æ˜¾ç¤ºåŒºåŸŸ
        const initialTab = "{{ initial_tab }}";
        if(initialTab && initialTab !== 'None') {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const target = document.getElementById(initialTab);
            if(target) target.classList.add('active');
        }

        // --- ç³»ç»Ÿç¡®è®¤æ¨¡æ€æ¡†é€»è¾‘ ---
        const modal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalActions = document.getElementById('modalActions');
        const modalContent = modal.querySelector('.modal-content');

        function closeModal() {
            modal.classList.remove('visible');
            modalContent.classList.remove('modal-result');
        }

        function showResultModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalActions.innerHTML = `<button class="modal-btn-cancel" onclick="closeModal()">ç¡®å®š</button>`;
            modalContent.classList.add('modal-result');
            modal.classList.add('visible');
        }

        function showSysConfirm(type) {
            const actionName = type === 'reboot' ? 'é‡å¯' : 'å…³æœº';
            modalTitle.textContent = ` é«˜å±æ“ä½œè­¦å‘Š âš ï¸`;
            modalMessage.innerHTML = `æ‚¨ç¡®å®šè¦å¼ºåˆ¶ [${actionName}] æ ‘è“æ´¾å—ï¼Ÿ<br>è¿™å°†å¯¼è‡´æ‰€æœ‰æœåŠ¡åœæ­¢ï¼`;
            
            modalActions.innerHTML = `
                <button class="modal-btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn-confirm" onclick="sysAction('${type}')">${actionName}</button>
            `;
            modalContent.classList.remove('modal-result');
            modal.classList.add('visible');
        }

        async function sysAction(type) {
            closeModal();
            const actionName = type === 'reboot' ? 'é‡å¯' : 'å…³æœº';
            try {
                const res = await fetch(`/api/system/${type}`, { method: 'POST' });
                const data = await res.json();
                if(res.ok) {
                    showResultModal(`âœ… ${actionName} æŒ‡ä»¤å‘é€æˆåŠŸ`, `${data.msg}\né¡µé¢å³å°†æ–­å¼€è¿æ¥ã€‚`);
                } else {
                    showResultModal(`âŒ ${actionName} æŒ‡ä»¤å¤±è´¥`, `æ“ä½œå¤±è´¥: ${data.msg}`);
                }
            } catch(e) {
                showResultModal("ğŸš¨ é€šä¿¡é”™è¯¯", "æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ã€‚");
            }
        }

        // --- âœ¨ WiFi æ¨¡æ€æ¡†é€»è¾‘ (å·²ä¿®å¤ Open ç½‘ç»œæ”¯æŒ) âœ¨ ---
        const wifiModal = document.getElementById('wifiModal');
        const wifiListEl = document.getElementById('wifiList');
        const wifiInputGroup = document.getElementById('wifiInputGroup');
        const selectedSsidEl = document.getElementById('selectedSsid');
        const wifiPasswordInput = document.getElementById('wifiPassword');
        let currentSsid = '';
        let currentSecurity = 'OPEN'; // æ–°å¢ï¼šè®°å½•å½“å‰ç½‘ç»œçš„å®‰å…¨ç±»å‹

        function openWifiModal() {
            wifiModal.classList.add('visible');
            wifiInputGroup.style.display = 'none'; // éšè—è¾“å…¥æ¡†
            refreshWifiList(); // æ‰“å¼€æ—¶è‡ªåŠ¨æ‰«æ
        }

        function closeWifiModal() {
            wifiModal.classList.remove('visible');
        }

        async function refreshWifiList() {
            wifiListEl.innerHTML = '<div style="padding: 20px;">æ­£åœ¨æ‰«æé™„è¿‘ä¿¡å·... <div class="loader"></div></div>';
            wifiInputGroup.style.display = 'none';
            
            try {
                const res = await fetch('/api/wifi/scan');
                const data = await res.json();
                
                if(data.status === 'ok') {
                    renderWifiList(data.networks);
                } else {
                    wifiListEl.innerHTML = `<div style="color:var(--danger); padding:20px;">æ‰«æå¤±è´¥: ${data.msg}</div>`;
                }
            } catch (e) {
                wifiListEl.innerHTML = `<div style="color:var(--danger); padding:20px;">è¯·æ±‚å¤±è´¥: æ— æ³•è¿æ¥æœåŠ¡å™¨</div>`;
            }
        }

        function renderWifiList(networks) {
            if(networks.length === 0) {
                wifiListEl.innerHTML = '<div style="padding: 20px;">æœªå‘ç°ç½‘ç»œ</div>';
                return;
            }
            
            let html = '';
            networks.forEach(net => {
                const activeClass = net.active ? 'active' : '';
                const lockIcon = net.security ? 'ğŸ”’' : '';
                // âš ï¸ å…³é”®ä¿®æ”¹ï¼šæå–å®‰å…¨ç±»å‹ï¼Œè‹¥æ— åˆ™é»˜è®¤ä¸º OPEN
                const securityType = net.security ? net.security : 'OPEN';
                
                // å°† securityType ä¼ é€’ç»™ selectWifi
                html += `
                    <div class="wifi-item ${activeClass}" onclick="selectWifi('${net.ssid}', '${securityType}')">
                        <div>
                            <div class="wifi-ssid">${net.ssid} ${net.active ? '(å½“å‰è¿æ¥)' : ''}</div>
                            <div class="wifi-info">ä¿¡å·: ${net.signal}% | å®‰å…¨: ${net.security || 'OPEN'}</div>
                        </div>
                        <div>${lockIcon}</div>
                    </div>
                `;
            });
            wifiListEl.innerHTML = html;
        }

        // âš ï¸ å…³é”®ä¿®æ”¹ï¼šæ¥æ”¶ security å‚æ•°
        function selectWifi(ssid, security) {
            currentSsid = ssid;
            currentSecurity = security; // è®°å½•çŠ¶æ€
            selectedSsidEl.textContent = ssid;
            
            wifiInputGroup.style.display = 'block';
            
            // åˆ¤æ–­æ˜¯å¦éšè—å¯†ç æ¡†
            if (security === 'OPEN' || security === null || security === '') {
                wifiPasswordInput.style.display = 'none'; // éšè—
                wifiPasswordInput.value = ''; // æ¸…ç©º
            } else {
                wifiPasswordInput.style.display = 'block'; // æ˜¾ç¤º
                wifiPasswordInput.value = ''; 
                wifiPasswordInput.focus();
            }
        }

        async function connectWifi() {
            // âš ï¸ å…³é”®ä¿®æ”¹ï¼šæ ¹æ®å®‰å…¨ç±»å‹å†³å®šå¯†ç 
            const password = (currentSecurity === 'OPEN') ? '' : wifiPasswordInput.value;
            
            if(!currentSsid) return;

            // âš ï¸ æ ¡éªŒé€»è¾‘ï¼šåªæœ‰åŠ å¯†ç½‘ç»œä¸”æ²¡å¡«å¯†ç æ‰æŠ¥é”™
            if (currentSecurity !== 'OPEN' && !password) {
                showResultModal('æç¤º', 'è¯·è¾“å…¥ WiFi å¯†ç ');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const btn = document.querySelector('#wifiInputGroup button');
            const originalText = btn.textContent;
            btn.textContent = 'è¿æ¥ä¸­...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/wifi/connect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ssid: currentSsid, password: password })
                });
                const data = await res.json();
                
                closeWifiModal(); // å…³é—­ WiFi å¼¹çª—
                if (res.ok) {
                    showResultModal('âœ… è¿æ¥æˆåŠŸ', `å·²è¿æ¥åˆ° ${currentSsid}ã€‚\nIP åœ°å€å¯èƒ½ä¼šå˜æ›´ï¼Œè¯·æ³¨æ„æ£€æŸ¥ã€‚`);
                } else {
                    showResultModal('âŒ è¿æ¥å¤±è´¥', data.msg);
                }
            } catch (e) {
                closeWifiModal();
                showResultModal('ğŸš¨ é”™è¯¯', 'å‘é€è¿æ¥è¯·æ±‚å¤±è´¥ã€‚');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>